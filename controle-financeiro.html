<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <style>
        /* Estilos anteriores (sem grandes mudanÃ§as aqui, exceto talvez para a nova aba/seÃ§Ã£o de config) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 300; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .tab { flex: 1; padding: 15px 20px; background: #f8f9fa; border: none; cursor: pointer; font-size: 16px; font-weight: 500; transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; border-bottom-color: #007bff; color: #007bff; }
        .tab-content { display: none; padding: 30px; min-height: 600px; }
        .tab-content.active { display: block; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #007bff; transition: transform 0.3s ease; }
        .card:hover { transform: translateY(-5px); }
        .card.receita { border-left-color: #28a745; } .card.despesa { border-left-color: #dc3545; } .card.investimento { border-left-color: #6f42c1; } .card.reserva { border-left-color: #fd7e14; }
        .card h3 { color: #495057; margin-bottom: 10px; font-size: 1.1em; }
        .card .valor { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .card.receita .valor { color: #28a745; } .card.despesa .valor { color: #dc3545; } .card.investimento .valor { color: #6f42c1; } .card.reserva .valor { color: #fd7e14; }
        .form-section { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; }
        .form-section h3 { margin-bottom: 20px; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 500; color: #495057; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .btn { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; margin-right: 10px; }
        .btn:last-child { margin-right: 0; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); } .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); } .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%); } .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #545b62 100%); }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .table th { background: linear-gradient(135deg, #495057 0%, #343a40 100%); color: white; padding: 15px; text-align: left; font-weight: 500; }
        .table td { padding: 12px 15px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        .table td .btn { padding: 6px 12px; font-size: 14px; }
        .table tr:hover { background: #f8f9fa; } .status-adequada { color: #28a745; font-weight: bold; } .status-inadequada { color: #dc3545; font-weight: bold; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%); transition: width 1s ease; }
        .lista-transacoes { max-height: 400px; overflow-y: auto; } .receita-item { border-left: 4px solid #28a745; } .despesa-item { border-left: 4px solid #dc3545; } .investimento-item { border-left: 4px solid #6f42c1; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content p { font-size: 18px; margin-bottom: 20px; } .modal-content .btn { margin-top: 10px; }
        .form-buttons { margin-top: 20px; }

        /* Estilos para Gerenciamento de Categorias */
        .category-management-section { display: flex; gap: 30px; }
        .category-column { flex: 1; }
        .category-column h4 { margin-bottom: 15px; color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
        .category-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding:10px; background: #fff; }
        .category-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; }
        .category-list li:last-child { border-bottom: none; }
        .category-list .btn-danger { padding: 3px 8px; font-size: 12px; }
        .add-category-form { display: flex; gap: 10px; margin-bottom: 15px; }
        .add-category-form input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .add-category-form .btn { padding: 10px 15px; font-size: 14px; }


        @media (max-width: 768px) { .tabs { flex-direction: column; } .dashboard { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .modal-content { width: 90%; } .category-management-section { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° Controle Financeiro Pessoal</h1>
            <p>Gerencie suas finanÃ§as de forma inteligente e eficiente</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab" onclick="openTab(event, 'receitas')">ğŸ’° Receitas</button>
            <button class="tab" onclick="openTab(event, 'despesas')">ğŸ’¸ Despesas</button>
            <button class="tab" onclick="openTab(event, 'investimentos')">ğŸ“ˆ Investimentos</button>
            <button class="tab" onclick="openTab(event, 'reserva')">ğŸ›¡ï¸ Reserva</button>
            <button class="tab" onclick="openTab(event, 'configuracoes')">âš™ï¸ ConfiguraÃ§Ãµes</button> <button class="tab" onclick="openTab(event, 'dados')">ğŸ’¾ Dados</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <div class="card receita"><h3>ğŸ’° Receitas do MÃªs</h3><div class="valor" id="totalReceitas">R$ 0,00</div><small>Total de entradas</small></div>
                <div class="card despesa"><h3>ğŸ’¸ Despesas do MÃªs</h3><div class="valor" id="totalDespesas">R$ 0,00</div><small>Total de saÃ­das</small></div>
                <div class="card"><h3>ğŸ“Š Saldo do MÃªs</h3><div class="valor" id="saldoMes">R$ 0,00</div><small>Receitas - Despesas</small></div>
                <div class="card investimento"><h3>ğŸ“ˆ Total Investido</h3><div class="valor" id="totalInvestimentos">R$ 0,00</div><small>PatrimÃ´nio em investimentos</small></div>
                <div class="card reserva"><h3>ğŸ›¡ï¸ Reserva de EmergÃªncia</h3><div class="valor" id="reservaAtual">R$ 0,00</div><small id="statusReserva">Status da reserva</small></div>
                <div class="card"><h3>ğŸ¯ Meta da Reserva</h3><div class="valor" id="metaReserva">R$ 0,00</div><small>6 meses de gastos essenciais</small><div class="progress-bar"><div class="progress-fill" id="progressReserva" style="width: 0%"></div></div></div>
            </div>
            <div class="form-section">
                <h3>ğŸ“‹ Ãšltimas TransaÃ§Ãµes</h3>
                <div class="lista-transacoes"><table class="table" id="tabelaTransacoes"><thead><tr><th>Data</th><th>Tipo</th><th>DescriÃ§Ã£o</th><th>Categoria</th><th>Valor</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <div id="receitas" class="tab-content">
            <div class="form-section">
                <h3 id="formReceitaTitulo">ğŸ’° Adicionar Receita</h3>
                <form id="formReceita">
                    <div class="form-row">
                        <div class="form-group"><label>Data</label><input type="date" id="dataReceita" required></div>
                        <div class="form-group"><label>DescriÃ§Ã£o</label><input type="text" id="descricaoReceita" placeholder="Ex: SalÃ¡rio, Freelance..." required></div>
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="categoriaReceita" required>
                                <option value="">Selecione...</option>
                                </select>
                        </div>
                        <div class="form-group"><label>Valor (R$)</label><input type="number" id="valorReceita" step="0.01" min="0" placeholder="0,00" required></div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-success" id="btnSubmitReceita">Adicionar Receita</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelarEdicaoReceita" style="display:none;" onclick="cancelarEdicao('receita')">Cancelar EdiÃ§Ã£o</button>
                    </div>
                </form>
            </div>
            <div class="form-section"><h3>ğŸ“Š Lista de Receitas (<span id="contadorReceitas">0</span>)</h3><table class="table"><thead><tr><th>Data</th><th>DescriÃ§Ã£o</th><th>Categoria</th><th>Valor</th><th>AÃ§Ãµes</th></tr></thead><tbody id="listaReceitas"></tbody></table></div>
        </div>

        <div id="despesas" class="tab-content">
            <div class="form-section">
                <h3 id="formDespesaTitulo">ğŸ’¸ Adicionar Despesa</h3>
                <form id="formDespesa">
                    <div class="form-row">
                        <div class="form-group"><label>Data</label><input type="date" id="dataDespesa" required></div>
                        <div class="form-group"><label>DescriÃ§Ã£o</label><input type="text" id="descricaoDespesa" placeholder="Ex: Supermercado, CombustÃ­vel..." required></div>
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="categoriaDespesa" required>
                                 <option value="">Selecione...</option>
                                </select>
                        </div>
                        <div class="form-group"><label>Valor (R$)</label><input type="number" id="valorDespesa" step="0.01" min="0" placeholder="0,00" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Tipo</label><select id="tipoDespesa" required><option value="">Selecione...</option><option value="Fixo">Fixo</option><option value="VariÃ¡vel">VariÃ¡vel</option></select></div>
                        <div class="form-group"><label>Forma de Pagamento</label><select id="pagamentoDespesa" required><option value="">Selecione...</option><option value="Dinheiro">ğŸ’µ Dinheiro</option><option value="CartÃ£o DÃ©bito">ğŸ’³ CartÃ£o DÃ©bito</option><option value="CartÃ£o CrÃ©dito">ğŸ’³ CartÃ£o CrÃ©dito</option><option value="PIX">ğŸ“± PIX</option><option value="TransferÃªncia">ğŸ¦ TransferÃªncia</option></select></div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-danger" id="btnSubmitDespesa">Adicionar Despesa</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelarEdicaoDespesa" style="display:none;" onclick="cancelarEdicao('despesa')">Cancelar EdiÃ§Ã£o</button>
                    </div>
                </form>
            </div>
            <div class="form-section"><h3>ğŸ“Š Lista de Despesas (<span id="contadorDespesas">0</span>)</h3><table class="table"><thead><tr><th>Data</th><th>DescriÃ§Ã£o</th><th>Categoria</th><th>Tipo</th><th>Pagamento</th><th>Valor</th><th>AÃ§Ãµes</th></tr></thead><tbody id="listaDespesas"></tbody></table></div>
        </div>

        <div id="investimentos" class="tab-content">
             <div class="form-section">
                <h3 id="formInvestimentoTitulo">ğŸ“ˆ Adicionar Investimento</h3>
                <form id="formInvestimento">
                    <div class="form-row">
                        <div class="form-group"><label>Data da AplicaÃ§Ã£o</label><input type="date" id="dataInvestimento" required></div>
                        <div class="form-group"><label>Tipo de Investimento</label><select id="tipoInvestimento" required><option value="">Selecione...</option><option value="PoupanÃ§a">ğŸ’° PoupanÃ§a</option><option value="CDB">ğŸ¦ CDB</option><option value="Tesouro Direto">ğŸ›ï¸ Tesouro Direto</option><option value="AÃ§Ãµes">ğŸ“Š AÃ§Ãµes</option><option value="Fundos">ğŸ“ˆ Fundos de Investimento</option><option value="Outros">ğŸ“¦ Outros</option></select></div>
                        <div class="form-group"><label>InstituiÃ§Ã£o</label><input type="text" id="instituicaoInvestimento" placeholder="Ex: Banco, Corretora..." required></div>
                        <div class="form-group"><label>Valor Aplicado (R$)</label><input type="number" id="valorInvestimento" step="0.01" min="0" placeholder="0,00" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Rentabilidade Esperada (% a.a.)</label><input type="number" id="rentabilidadeInvestimento" step="0.01" min="0" placeholder="0,00"></div>
                        <div class="form-group"><label>Valor Atual (R$)</label><input type="number" id="valorAtualInvestimento" step="0.01" min="0" placeholder="0,00"></div>
                    </div>
                     <div class="form-buttons">
                        <button type="submit" class="btn" id="btnSubmitInvestimento">Adicionar Investimento</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelarEdicaoInvestimento" style="display:none;" onclick="cancelarEdicao('investimento')">Cancelar EdiÃ§Ã£o</button>
                    </div>
                </form>
            </div>
            <div class="form-section"><h3>ğŸ“Š Carteira de Investimentos (<span id="contadorInvestimentos">0</span>)</h3><table class="table"><thead><tr><th>Data</th><th>Tipo</th><th>InstituiÃ§Ã£o</th><th>Valor Aplicado</th><th>Valor Atual</th><th>Rentabilidade</th><th>Rendimento</th><th>AÃ§Ãµes</th></tr></thead><tbody id="listaInvestimentos"></tbody></table></div>
        </div>

        <div id="reserva" class="tab-content">
            <div class="dashboard"><div class="card reserva"><h3>ğŸ›¡ï¸ Reserva Atual</h3><div class="valor" id="reservaAtualPage">R$ 0,00</div><small>Valor disponÃ­vel para emergÃªncias</small></div><div class="card"><h3>ğŸ¯ Meta de Reserva</h3><div class="valor" id="metaReservaPage">R$ 0,00</div><small>6 meses de gastos essenciais</small></div><div class="card"><h3>ğŸ“Š Progresso</h3><div class="valor" id="percentualReserva">0%</div><small>Da meta alcanÃ§ada</small><div class="progress-bar"><div class="progress-fill" id="progressReservaPage" style="width: 0%"></div></div></div><div class="card"><h3>ğŸ’° Falta Investir</h3><div class="valor" id="faltaReserva">R$ 0,00</div><small>Para completar a reserva</small></div></div><div class="form-section"><h3>ğŸ”§ Configurar Reserva de EmergÃªncia</h3><form id="formReserva" onsubmit="configurarReserva(event)"><div class="form-row"><div class="form-group"><label>Valor Atual da Reserva (R$)</label><input type="number" id="valorReservaAtual" step="0.01" min="0" placeholder="0,00"></div><div class="form-group"><label>Gastos Essenciais Mensais (R$)</label><input type="number" id="gastosEssenciais" step="0.01" min="0" placeholder="0,00"><small>Moradia + AlimentaÃ§Ã£o + Transporte + SaÃºde</small></div></div><button type="submit" class="btn">Atualizar Reserva</button></form></div><div class="form-section"><h3>ğŸ“‹ AnÃ¡lise da Reserva</h3><div id="analiseReserva"><p><strong>Status da Reserva:</strong> <span id="statusReservaTexto">Configure os valores</span></p><p><strong>Meses de ProteÃ§Ã£o:</strong> <span id="mesesProtecao">0 meses</span></p><p><strong>RecomendaÃ§Ã£o:</strong> <span id="recomendacao">Configure sua reserva</span></p></div></div>
        </div>

        <div id="configuracoes" class="tab-content">
            <div class="form-section">
                <h3>âš™ï¸ Gerenciar Categorias</h3>
                <div class="category-management-section">
                    <div class="category-column">
                        <h4>Categorias de Receita</h4>
                        <div class="add-category-form">
                            <input type="text" id="inputNovaCategoriaReceita" placeholder="Nova categoria de receita">
                            <button class="btn btn-success" onclick="adicionarNovaCategoria('receita')">Adicionar</button>
                        </div>
                        <ul id="listaCategoriasReceita" class="category-list">
                            </ul>
                    </div>
                    <div class="category-column">
                        <h4>Categorias de Despesa</h4>
                        <div class="add-category-form">
                            <input type="text" id="inputNovaCategoriaDespesa" placeholder="Nova categoria de despesa">
                            <button class="btn btn-success" onclick="adicionarNovaCategoria('despesa')">Adicionar</button>
                        </div>
                        <ul id="listaCategoriasDespesa" class="category-list">
                            </ul>
                    </div>
                </div>
            </div>
        </div>


        <div id="dados" class="tab-content">
            <div class="form-section"><h3>ğŸ’¾ Backup e RestauraÃ§Ã£o</h3><p>Salve ou carregue seus dados.</p><div class="form-row"><div class="form-group"><button class="btn btn-success" onclick="exportarDados()">ğŸ“¤ Exportar</button><small>Baixar arquivo JSON</small></div><div class="form-group"><button class="btn" onclick="copiarDadosAreaTransferencia()">ğŸ“‹ Copiar</button><small>Copiar JSON</small></div></div><div class="form-row"><div class="form-group"><input type="file" id="arquivoImport" accept=".json" style="display:none" onchange="importarDados(event)"><button class="btn" onclick="document.getElementById('arquivoImport').click()">ğŸ“¥ Importar Arquivo</button><small>Carregar de JSON</small></div><div class="form-group"><button class="btn" onclick="mostrarAreaImportacao()">ğŸ“ Importar Texto</button><small>Colar JSON</small></div></div><div id="areaImportacaoTexto" style="display:none;margin-top:20px"><h4>Importar via texto</h4><textarea id="textoImportacao" placeholder="Cole JSON aqui..." style="width:100%;height:200px;padding:15px;border:2px solid #dee2e6;border-radius:8px;font-family:monospace;font-size:14px;resize:vertical"></textarea><div style="margin-top:10px"><button class="btn btn-success" onclick="importarViaTexto()">Importar</button><button class="btn btn-secondary" onclick="ocultarAreaImportacao()">Cancelar</button></div></div><div class="form-row"><div class="form-group"><button class="btn btn-danger" onclick="limparTodosDados()">ğŸ—‘ï¸ Limpar Tudo</button><small>Remove todos os dados</small></div></div></div><div class="form-section"><h3>ğŸ“Š EstatÃ­sticas</h3><div class="dashboard"><div class="card"><h3>ğŸ’° Total Receitas</h3><div class="valor" id="totalReceitasCadastradas">0</div><small>Registros</small></div><div class="card"><h3>ğŸ’¸ Total Despesas</h3><div class="valor" id="totalDespesasCadastradas">0</div><small>Registros</small></div><div class="card"><h3>ğŸ“ˆ Total Investimentos</h3><div class="valor" id="totalInvestimentosCadastrados">0</div><small>Registros</small></div><div class="card"><h3>ğŸ“… Primeiro Registro</h3><div class="valor" id="primeiroRegistro">-</div><small>Data mais antiga</small></div></div></div><div class="form-section"><h3>ğŸ”„ Auto-Save</h3><p>Dados salvos no navegador.</p><div class="form-row"><div class="form-group"><button class="btn" onclick="salvarDados()">ğŸ’¾ Salvar Manual</button><small>ForÃ§ar salvamento</small></div><div class="form-group"><button class="btn" onclick="carregarDados()">ğŸ”„ Recarregar</button><small>Recarregar salvos</small></div></div><div style="margin-top:20px;padding:15px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3"><p><strong>â„¹ï¸ Armazenamento:</strong></p><ul style="margin:10px 0;padding-left:20px"><li>Dados salvos no seu navegador (localStorage).</li><li>Persistem ao fechar/abrir.</li><li>Use Exportar/Importar para backups.</li><li>Salvos apenas neste navegador/dispositivo.</li></ul></div></div>
        </div>
    </div>

    <div id="confirmModal" class="modal"> <div class="modal-content"> <p id="modalMessageText"></p> <div class="form-buttons"> <button id="modalConfirmButton" class="btn btn-danger">Confirmar</button> <button id="modalCancelButton" class="btn btn-secondary">Cancelar</button> </div> </div> </div>

    <script>
        // Dados em memÃ³ria
        let receitas = [];
        let despesas = [];
        let investimentos = [];
        let configuracaoReserva = { valorAtual: 0, gastosEssenciais: 0 };

        // Categorias
        const defaultCategoriasReceita = ["SalÃ¡rio", "Freelance", "Rendimentos de Investimentos", "Vendas", "Outros"];
        const defaultCategoriasDespesa = ["Moradia", "AlimentaÃ§Ã£o", "Transporte", "SaÃºde", "EducaÃ§Ã£o", "Lazer", "ServiÃ§os", "VestuÃ¡rio", "Impostos", "Outros"];
        let customCategoriasReceita = [];
        let customCategoriasDespesa = [];

        // IDs para ediÃ§Ã£o
        let editingReceitaId = null;
        let editingDespesaId = null;
        let editingInvestimentoId = null;
        let modalConfirmCallback = null;

        // --- MODAL FUNCTIONS ---
        const confirmModal = document.getElementById('confirmModal');
        const modalMessageText = document.getElementById('modalMessageText');
        const modalConfirmButton = document.getElementById('modalConfirmButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        function abrirModalConfirmacao(message, callback) { modalMessageText.textContent = message; modalConfirmCallback = callback; confirmModal.style.display = 'block'; }
        function fecharModalConfirmacao() { confirmModal.style.display = 'none'; modalConfirmCallback = null; }
        modalConfirmButton.onclick = () => { if (typeof modalConfirmCallback === 'function') modalConfirmCallback(); fecharModalConfirmacao(); };
        modalCancelButton.onclick = fecharModalConfirmacao;
        window.onclick = (event) => { if (event.target == confirmModal) fecharModalConfirmacao(); };

        // --- SISTEMA DE ARMAZENAMENTO ---
        function salvarDados() {
            try {
                const dados = { receitas, despesas, investimentos, configuracaoReserva, customCategoriasReceita, customCategoriasDespesa, dataUltimoSave: new Date().toISOString() };
                localStorage.setItem('dadosFinanceirosApp', JSON.stringify(dados));
                window.dadosParaDownload = JSON.stringify(dados, null, 2);
                console.log('Dados salvos:', dados);
                return true;
            } catch (e) { mostrarNotificacao('Erro ao salvar: ' + e.message, 'error'); return false; }
        }

        function carregarDados() {
            try {
                const dadosString = localStorage.getItem('dadosFinanceirosApp');
                if (dadosString) {
                    const dados = JSON.parse(dadosString);
                    receitas = dados.receitas || [];
                    despesas = dados.despesas || [];
                    investimentos = dados.investimentos || [];
                    configuracaoReserva = dados.configuracaoReserva || { valorAtual: 0, gastosEssenciais: 0 };
                    customCategoriasReceita = dados.customCategoriasReceita || [];
                    customCategoriasDespesa = dados.customCategoriasDespesa || [];
                    
                    popularTodosOsDropdownsDeCategoria(); // Popula antes de atualizar interface
                    atualizarInterfaceCompleta();
                    renderizarListasDeCategoriasGerenciador(); // Renderiza na aba Config
                    mostrarNotificacao('Dados carregados!', 'success');
                } else {
                    popularTodosOsDropdownsDeCategoria();
                    atualizarInterfaceCompleta();
                    renderizarListasDeCategoriasGerenciador();
                    mostrarNotificacao('Nenhum dado salvo.', 'info');
                }
            } catch (e) {
                mostrarNotificacao('Erro ao carregar: ' + e.message, 'error');
                // Reset bÃ¡sico em caso de erro grave de parse
                receitas = []; despesas = []; investimentos = []; configuracaoReserva = { valorAtual: 0, gastosEssenciais: 0 }; customCategoriasReceita = []; customCategoriasDespesa = [];
                popularTodosOsDropdownsDeCategoria();
                atualizarInterfaceCompleta();
                renderizarListasDeCategoriasGerenciador();
            }
        }

        function atualizarInterfaceCompleta() {
            atualizarDashboard();
            atualizarAnaliseReserva();
            atualizarEstatisticasDados();
            if (document.getElementById('valorReservaAtual')) {
                 document.getElementById('valorReservaAtual').value = configuracaoReserva.valorAtual || 0;
                 document.getElementById('gastosEssenciais').value = configuracaoReserva.gastosEssenciais || 0;
            }
        }
        
        // --- GERENCIAMENTO DE CATEGORIAS ---
        function popularDropdown(selectId, defaultCats, customCats, valorAtual = null) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '<option value="">Selecione...</option>'; // Limpa e adiciona placeholder

            const todasCategorias = [...new Set([...defaultCats, ...customCats])].sort((a, b) => a.localeCompare(b));

            todasCategorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
             if (valorAtual) selectElement.value = valorAtual; // Tenta manter o valor selecionado
        }

        function popularTodosOsDropdownsDeCategoria(categoriaSelecionadaReceita = null, categoriaSelecionadaDespesa = null) {
            popularDropdown('categoriaReceita', defaultCategoriasReceita, customCategoriasReceita, categoriaSelecionadaReceita);
            popularDropdown('categoriaDespesa', defaultCategoriasDespesa, customCategoriasDespesa, categoriaSelecionadaDespesa);
        }

        function renderizarListaCategorias(tipo) {
            const listaUlId = tipo === 'receita' ? 'listaCategoriasReceita' : 'listaCategoriasDespesa';
            const categoriasCustom = tipo === 'receita' ? customCategoriasReceita : customCategoriasDespesa;
            const ulElement = document.getElementById(listaUlId);
            ulElement.innerHTML = '';

            categoriasCustom.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat;
                const btnRemover = document.createElement('button');
                btnRemover.textContent = 'Remover';
                btnRemover.className = 'btn btn-danger btn-sm'; // btn-sm para menor
                btnRemover.onclick = () => removerCategoria(tipo, cat);
                li.appendChild(btnRemover);
                ulElement.appendChild(li);
            });
        }
        function renderizarListasDeCategoriasGerenciador(){
            renderizarListaCategorias('receita');
            renderizarListaCategorias('despesa');
        }

        function adicionarNovaCategoria(tipo) {
            const inputId = tipo === 'receita' ? 'inputNovaCategoriaReceita' : 'inputNovaCategoriaDespesa';
            const inputElement = document.getElementById(inputId);
            const nomeCategoria = inputElement.value.trim();

            if (!nomeCategoria) {
                mostrarNotificacao('Nome da categoria nÃ£o pode ser vazio.', 'error');
                return;
            }

            const defaultArray = tipo === 'receita' ? defaultCategoriasReceita : defaultCategoriasDespesa;
            const customArray = tipo === 'receita' ? customCategoriasReceita : customCategoriasDespesa;

            if (defaultArray.includes(nomeCategoria) || customArray.includes(nomeCategoria)) {
                mostrarNotificacao('Esta categoria jÃ¡ existe.', 'info');
                return;
            }

            customArray.push(nomeCategoria);
            inputElement.value = '';
            salvarDados();
            renderizarListaCategorias(tipo);
            popularTodosOsDropdownsDeCategoria(); // Atualiza os selects nos formulÃ¡rios
            mostrarNotificacao(`Categoria "${nomeCategoria}" adicionada.`, 'success');
        }

        function removerCategoria(tipo, nomeCategoria) {
            abrirModalConfirmacao(`Remover a categoria "${nomeCategoria}"? TransaÃ§Ãµes existentes com esta categoria nÃ£o serÃ£o alteradas, mas a categoria nÃ£o estarÃ¡ mais disponÃ­vel para seleÃ§Ã£o.`, () => {
                if (tipo === 'receita') {
                    customCategoriasReceita = customCategoriasReceita.filter(cat => cat !== nomeCategoria);
                } else {
                    customCategoriasDespesa = customCategoriasDespesa.filter(cat => cat !== nomeCategoria);
                }
                salvarDados();
                renderizarListaCategorias(tipo);
                popularTodosOsDropdownsDeCategoria(); // Atualiza os selects nos formulÃ¡rios
                mostrarNotificacao(`Categoria "${nomeCategoria}" removida.`, 'info');
            });
        }


        // --- EXPORT/IMPORT E DADOS --- (FunÃ§Ãµes como exportarDados, importarDados, etc. permanecem iguais, apenas se certificando que chamam salvarDados/carregarDados/atualizarInterfaceCompleta corretamente)
        function exportarDados() { /* ... (cÃ³digo anterior, jÃ¡ chama salvarDados) ... */ 
             try {
                salvarDados(); 
                const dados = { receitas, despesas, investimentos, configuracaoReserva, customCategoriasReceita, customCategoriasDespesa, dataExportacao: new Date().toISOString(), versao: '1.0', info: 'Backup do Controle Financeiro Pessoal' };
                const dadosJSON = JSON.stringify(dados, null, 2);
                const blob = new Blob([dadosJSON], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const agora = new Date();
                const nomeArquivo = `backup-financeiro-${agora.toISOString().split('T')[0]}-${agora.toTimeString().split(' ')[0].replace(/:/g, '-')}.json`;
                const link = document.createElement('a');
                link.href = url; link.download = nomeArquivo; link.style.display = 'none';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                mostrarNotificacao(`Backup exportado: ${nomeArquivo}`, 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error); mostrarNotificacao('Erro ao exportar dados: ' + error.message, 'error');
            }
        }
        function importarDados(event) { /* ... (cÃ³digo anterior) ... */ 
            const arquivo = event.target.files[0]; if (!arquivo) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { processarImportacao(e.target.result); } 
                catch (error) { mostrarNotificacao('Erro ao ler arquivo: ' + error.message, 'error'); }
            };
            reader.readAsText(arquivo); event.target.value = null;
        }
        function copiarDadosAreaTransferencia() { /* ... (cÃ³digo anterior, jÃ¡ chama salvarDados) ... */ 
             try {
                salvarDados();
                const dados = { receitas, despesas, investimentos, configuracaoReserva, customCategoriasReceita, customCategoriasDespesa, dataExportacao: new Date().toISOString(), versao: '1.0', info: 'Backup do Controle Financeiro Pessoal' };
                const dadosJSON = JSON.stringify(dados, null, 2);
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(dadosJSON).then(() => mostrarNotificacao('Dados copiados!', 'success')).catch(() => copiarTextoFallback(dadosJSON));
                } else { copiarTextoFallback(dadosJSON); }
            } catch (error) { mostrarNotificacao('Erro ao copiar: ' + error.message, 'error'); }
        }
        function copiarTextoFallback(texto) { /* ... (cÃ³digo anterior) ... */ 
            try {
                const ta = document.createElement('textarea'); ta.value = texto; ta.style.position = 'fixed'; ta.style.left = '-9999px';
                document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                mostrarNotificacao('Copiado para Ã¡rea de transferÃªncia!', 'success');
            } catch (e) { mostrarNotificacao('CÃ³pia automÃ¡tica falhou. Dados no console.', 'info'); console.log(texto); }
        }
        function mostrarAreaImportacao() { /* ... (cÃ³digo anterior) ... */ document.getElementById('areaImportacaoTexto').style.display = 'block'; document.getElementById('textoImportacao').focus(); }
        function ocultarAreaImportacao() { /* ... (cÃ³digo anterior) ... */ document.getElementById('areaImportacaoTexto').style.display = 'none'; document.getElementById('textoImportacao').value = ''; }
        function importarViaTexto() { /* ... (cÃ³digo anterior) ... */
            const texto = document.getElementById('textoImportacao').value.trim();
            if (!texto) { mostrarNotificacao('Cole os dados JSON.', 'error'); return; }
            try { processarImportacao(texto); ocultarAreaImportacao(); } 
            catch (error) { mostrarNotificacao('Erro ao processar: ' + error.message, 'error');}
         }
        function processarImportacao(dadosTexto) { /* ... (atualizar para incluir categorias) ... */
            try {
                const dados = JSON.parse(dadosTexto);
                if (typeof dados !== 'object' || dados === null) throw new Error('Formato invÃ¡lido');
                receitas = Array.isArray(dados.receitas) ? dados.receitas : [];
                despesas = Array.isArray(dados.despesas) ? dados.despesas : [];
                investimentos = Array.isArray(dados.investimentos) ? dados.investimentos : [];
                configuracaoReserva = typeof dados.configuracaoReserva === 'object' && dados.configuracaoReserva !== null ? dados.configuracaoReserva : { valorAtual: 0, gastosEssenciais: 0 };
                customCategoriasReceita = Array.isArray(dados.customCategoriasReceita) ? dados.customCategoriasReceita : [];
                customCategoriasDespesa = Array.isArray(dados.customCategoriasDespesa) ? dados.customCategoriasDespesa : [];
                salvarDados();
                popularTodosOsDropdownsDeCategoria();
                atualizarInterfaceCompleta();
                renderizarListasDeCategoriasGerenciador();
                mostrarNotificacao(`${receitas.length + despesas.length + investimentos.length} registros importados!`, 'success');
            } catch (e) { console.error(e); mostrarNotificacao('Erro ao importar. Verifique JSON.', 'error'); }
        }
        function limparTodosDados() { /* ... (cÃ³digo anterior, jÃ¡ usa modal) ... */
            abrirModalConfirmacao('âš ï¸ Limpar TODOS os dados? IrreversÃ­vel!', () => {
                 abrirModalConfirmacao('ğŸš¨ ÃšLTIMA CONFIRMAÃ‡ÃƒO: Dados PERDIDOS. Continuar?', () => {
                    receitas = []; despesas = []; investimentos = []; configuracaoReserva = { valorAtual: 0, gastosEssenciais: 0 };
                    customCategoriasReceita = []; customCategoriasDespesa = []; // Limpa categorias customizadas
                    localStorage.removeItem('dadosFinanceirosApp');
                    popularTodosOsDropdownsDeCategoria();
                    atualizarInterfaceCompleta();
                    renderizarListasDeCategoriasGerenciador();
                    mostrarNotificacao('Todos os dados removidos.', 'info');
                });
            });
         }
        function atualizarEstatisticasDados() { /* ... (cÃ³digo anterior) ... */ 
            document.getElementById('totalReceitasCadastradas').textContent = receitas.length;
            document.getElementById('totalDespesasCadastradas').textContent = despesas.length;
            document.getElementById('totalInvestimentosCadastrados').textContent = investimentos.length;
            const todasDatas = [...receitas.map(r => r.data), ...despesas.map(d => d.data), ...investimentos.map(i => i.data)];
            if (todasDatas.length > 0) {
                todasDatas.sort((a, b) => new Date(a) - new Date(b));
                document.getElementById('primeiroRegistro').textContent = formatarData(todasDatas[0]);
            } else { document.getElementById('primeiroRegistro').textContent = '-'; }
        }
        function mostrarNotificacao(mensagem, tipo) { /* ... (cÃ³digo anterior) ... */ 
            const n = document.createElement('div');
            n.style.cssText = `position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;color:white;font-weight:500;z-index:9999;box-shadow:0 4px 15px rgba(0,0,0,0.2);transform:translateX(400px);transition:transform .3s ease;`;
            switch(tipo){case 'success':n.style.background='#28a745';break;case 'error':n.style.background='#dc3545';break;case 'info':n.style.background='#17a2b8';break;default:n.style.background='#6c757d';}
            n.textContent=mensagem;document.body.appendChild(n);
            setTimeout(()=>n.style.transform='translateX(0)',100);
            setTimeout(()=>{n.style.transform='translateX(400px)';setTimeout(()=>document.body.removeChild(n),300)},3000);
        }

        // --- NAVEGAÃ‡ÃƒO POR ABAS --- (sem alteraÃ§Ãµes)
        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- FORMATAÃ‡ÃƒO --- (sem alteraÃ§Ãµes)
        function formatarMoeda(valor) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor); }
        function formatarData(data) { return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR'); }

        // --- LÃ“GICA DE EDIÃ‡ÃƒO E CANCELAMENTO --- (sem grandes alteraÃ§Ãµes, mas garante que os dropdowns sejam repopulados com o valor correto)
        function cancelarEdicao(tipo) {
            let formId, dataId, tituloId, btnSubmitId, btnCancelarId, editingIdVarSetter;
            let defaultTitulo, defaultBtnText;
            let categoriaAtual = null;

            if (tipo === 'receita') {
                formId = 'formReceita'; dataId = 'dataReceita'; tituloId = 'formReceitaTitulo'; btnSubmitId = 'btnSubmitReceita'; btnCancelarId = 'btnCancelarEdicaoReceita';
                editingReceitaId = null; defaultTitulo = 'ğŸ’° Adicionar Receita'; defaultBtnText = 'Adicionar Receita';
                categoriaAtual = document.getElementById('categoriaReceita').value; // Salva antes de resetar
            } else if (tipo === 'despesa') {
                formId = 'formDespesa'; dataId = 'dataDespesa'; tituloId = 'formDespesaTitulo'; btnSubmitId = 'btnSubmitDespesa'; btnCancelarId = 'btnCancelarEdicaoDespesa';
                editingDespesaId = null; defaultTitulo = 'ğŸ’¸ Adicionar Despesa'; defaultBtnText = 'Adicionar Despesa';
                categoriaAtual = document.getElementById('categoriaDespesa').value; // Salva antes de resetar
            } else if (tipo === 'investimento') {
                formId = 'formInvestimento'; dataId = 'dataInvestimento'; tituloId = 'formInvestimentoTitulo'; btnSubmitId = 'btnSubmitInvestimento'; btnCancelarId = 'btnCancelarEdicaoInvestimento';
                editingInvestimentoId = null; defaultTitulo = 'ğŸ“ˆ Adicionar Investimento'; defaultBtnText = 'Adicionar Investimento';
            }

            document.getElementById(formId).reset();
            document.getElementById(dataId).value = new Date().toISOString().split('T')[0];
            document.getElementById(tituloId).textContent = defaultTitulo;
            document.getElementById(btnSubmitId).textContent = defaultBtnText;
            document.getElementById(btnCancelarId).style.display = 'none';

            if(tipo === 'receita') popularTodosOsDropdownsDeCategoria(null, document.getElementById('categoriaDespesa').value);
            if(tipo === 'despesa') popularTodosOsDropdownsDeCategoria(document.getElementById('categoriaReceita').value, null);

        }

        // --- RECEITAS ---
        document.getElementById('formReceita').addEventListener('submit', function(e) { /* ... (cÃ³digo anterior, mas usa popularTodosOsDropdownsDeCategoria ao popular para ediÃ§Ã£o) ... */ 
            e.preventDefault();
            const data = document.getElementById('dataReceita').value;
            const descricao = document.getElementById('descricaoReceita').value;
            const categoria = document.getElementById('categoriaReceita').value;
            const valor = parseFloat(document.getElementById('valorReceita').value);

            if(!categoria){ mostrarNotificacao('Selecione uma categoria para a receita.', 'error'); return; }

            if (editingReceitaId !== null) {
                const index = receitas.findIndex(r => r.id === editingReceitaId);
                if (index !== -1) { receitas[index] = { ...receitas[index], data, descricao, categoria, valor }; mostrarNotificacao('Receita atualizada!', 'success');}
                cancelarEdicao('receita');
            } else {
                receitas.push({ id: Date.now(), data, descricao, categoria, valor }); mostrarNotificacao('Receita adicionada!', 'success');
                document.getElementById('formReceita').reset(); document.getElementById('dataReceita').value = new Date().toISOString().split('T')[0];
                popularTodosOsDropdownsDeCategoria(null, document.getElementById('categoriaDespesa').value); // Repopula com "" selecionado
            }
            atualizarListaReceitas(); atualizarDashboard(); salvarDados();
        });
        function popularFormularioReceitaParaEdicao(id) {
            const receita = receitas.find(r => r.id === id);
            if (receita) {
                openTab(event, 'receitas'); 
                editingReceitaId = id;
                document.getElementById('dataReceita').value = receita.data;
                document.getElementById('descricaoReceita').value = receita.descricao;
                popularTodosOsDropdownsDeCategoria(receita.categoria, document.getElementById('categoriaDespesa').value); 
                document.getElementById('valorReceita').value = receita.valor;
                document.getElementById('formReceitaTitulo').textContent = 'ğŸ“ Editar Receita';
                document.getElementById('btnSubmitReceita').textContent = 'Atualizar Receita';
                document.getElementById('btnCancelarEdicaoReceita').style.display = 'inline-block';
                document.getElementById('formReceita').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('dataReceita').focus(); // <<< FOCO AUTOMÃTICO AQUI
            }
        }
        function atualizarListaReceitas() {
            const tbody = document.getElementById('listaReceitas'); tbody.innerHTML = '';
            receitas.forEach(r => {
                const tr = document.createElement('tr'); tr.className = 'receita-item';
                tr.innerHTML = `<td>${formatarData(r.data)}</td><td>${r.descricao}</td><td>${r.categoria}</td><td>${formatarMoeda(r.valor)}</td>
                    <td>
                        <button class="btn btn-info" onclick="popularFormularioReceitaParaEdicao(${r.id})">Editar</button>
                        <button class="btn btn-danger" onclick="removerReceita(${r.id})">Remover</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('contadorReceitas').textContent = receitas.length; // <<< ATUALIZAR CONTADOR
        }
        function removerReceita(id) { /* ... (cÃ³digo anterior, jÃ¡ usa modal) ... */
             abrirModalConfirmacao("Remover esta receita?", () => {
                receitas = receitas.filter(r => r.id !== id);
                atualizarListaReceitas(); atualizarDashboard(); salvarDados();
                mostrarNotificacao('Receita removida!', 'info');
            });
         }

        // --- DESPESAS ---
        document.getElementById('formDespesa').addEventListener('submit', function(e) { /* ... (cÃ³digo anterior, mas usa popularTodosOsDropdownsDeCategoria ao popular para ediÃ§Ã£o) ... */ 
            e.preventDefault();
            const data = document.getElementById('dataDespesa').value; const descricao = document.getElementById('descricaoDespesa').value;
            const categoria = document.getElementById('categoriaDespesa').value; const valor = parseFloat(document.getElementById('valorDespesa').value);
            const tipo = document.getElementById('tipoDespesa').value; const pagamento = document.getElementById('pagamentoDespesa').value;

            if(!categoria){ mostrarNotificacao('Selecione uma categoria para a despesa.', 'error'); return; }
            if(!tipo){ mostrarNotificacao('Selecione um tipo para a despesa.', 'error'); return; }
            if(!pagamento){ mostrarNotificacao('Selecione uma forma de pagamento.', 'error'); return; }


            if (editingDespesaId !== null) {
                const index = despesas.findIndex(d => d.id === editingDespesaId);
                if (index !== -1) { despesas[index] = { ...despesas[index], data, descricao, categoria, valor, tipo, pagamento }; mostrarNotificacao('Despesa atualizada!', 'success'); }
                cancelarEdicao('despesa');
            } else {
                despesas.push({ id: Date.now(), data, descricao, categoria, valor, tipo, pagamento }); mostrarNotificacao('Despesa adicionada!', 'success');
                document.getElementById('formDespesa').reset(); document.getElementById('dataDespesa').value = new Date().toISOString().split('T')[0];
                popularTodosOsDropdownsDeCategoria(document.getElementById('categoriaReceita').value, null); // Repopula com "" selecionado
            }
            atualizarListaDespesas(); atualizarDashboard(); salvarDados();
        });
        function popularFormularioDespesaParaEdicao(id) {
            const despesa = despesas.find(d => d.id === id);
            if (despesa) {
                openTab(event, 'despesas'); 
                editingDespesaId = id;
                document.getElementById('dataDespesa').value = despesa.data; 
                document.getElementById('descricaoDespesa').value = despesa.descricao;
                popularTodosOsDropdownsDeCategoria(document.getElementById('categoriaReceita').value, despesa.categoria); 
                document.getElementById('valorDespesa').value = despesa.valor; 
                document.getElementById('tipoDespesa').value = despesa.tipo; 
                document.getElementById('pagamentoDespesa').value = despesa.pagamento;
                document.getElementById('formDespesaTitulo').textContent = 'ğŸ“ Editar Despesa'; 
                document.getElementById('btnSubmitDespesa').textContent = 'Atualizar Despesa';
                document.getElementById('btnCancelarEdicaoDespesa').style.display = 'inline-block'; 
                document.getElementById('formDespesa').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('dataDespesa').focus(); // <<< FOCO AUTOMÃTICO AQUI
            }
        }
        function atualizarListaDespesas() {
            const tbody = document.getElementById('listaDespesas'); tbody.innerHTML = '';
            despesas.forEach(d => {
                const tr = document.createElement('tr'); tr.className = 'despesa-item';
                tr.innerHTML = `<td>${formatarData(d.data)}</td><td>${d.descricao}</td><td>${d.categoria}</td><td>${d.tipo}</td><td>${d.pagamento}</td><td>${formatarMoeda(d.valor)}</td>
                    <td>
                        <button class="btn btn-info" onclick="popularFormularioDespesaParaEdicao(${d.id})">Editar</button>
                        <button class="btn btn-danger" onclick="removerDespesa(${d.id})">Remover</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('contadorDespesas').textContent = despesas.length; // <<< ATUALIZAR CONTADOR
        }
        function removerDespesa(id) { /* ... (cÃ³digo anterior, jÃ¡ usa modal) ... */ 
            abrirModalConfirmacao("Remover esta despesa?", () => {
                despesas = despesas.filter(d => d.id !== id);
                atualizarListaDespesas(); atualizarDashboard(); salvarDados();
                mostrarNotificacao('Despesa removida!', 'info');
            });
        }

        // --- INVESTIMENTOS --- (LÃ³gica de ediÃ§Ã£o e formulÃ¡rio permanecem os mesmos da etapa anterior)
        document.getElementById('formInvestimento').addEventListener('submit', function(e) { /* ... (cÃ³digo anterior) ... */ 
            e.preventDefault();
            const data = document.getElementById('dataInvestimento').value; const tipo = document.getElementById('tipoInvestimento').value;
            const instituicao = document.getElementById('instituicaoInvestimento').value; const valorAplicado = parseFloat(document.getElementById('valorInvestimento').value);
            const rentabilidade = parseFloat(document.getElementById('rentabilidadeInvestimento').value) || 0;
            const valorAtualInput = document.getElementById('valorAtualInvestimento').value; const valorAtual = valorAtualInput ? parseFloat(valorAtualInput) : valorAplicado;

            if (editingInvestimentoId !== null) {
                const index = investimentos.findIndex(i => i.id === editingInvestimentoId);
                if (index !== -1) { investimentos[index] = { ...investimentos[index], data, tipo, instituicao, valorAplicado, rentabilidade, valorAtual }; mostrarNotificacao('Investimento atualizado!', 'success'); }
                cancelarEdicao('investimento');
            } else {
                investimentos.push({ id: Date.now(), data, tipo, instituicao, valorAplicado, rentabilidade, valorAtual }); mostrarNotificacao('Investimento adicionado!', 'success');
                document.getElementById('formInvestimento').reset(); document.getElementById('dataInvestimento').value = new Date().toISOString().split('T')[0];
            }
            atualizarListaInvestimentos(); atualizarDashboard(); salvarDados();
        });
        function popularFormularioInvestimentoParaEdicao(id) {
            const inv = investimentos.find(i => i.id === id);
            if (inv) {
                openTab(event, 'investimentos'); 
                editingInvestimentoId = id;
                document.getElementById('dataInvestimento').value = inv.data; 
                document.getElementById('tipoInvestimento').value = inv.tipo;
                document.getElementById('instituicaoInvestimento').value = inv.instituicao; 
                document.getElementById('valorInvestimento').value = inv.valorAplicado;
                document.getElementById('rentabilidadeInvestimento').value = inv.rentabilidade; 
                document.getElementById('valorAtualInvestimento').value = inv.valorAtual;
                document.getElementById('formInvestimentoTitulo').textContent = 'ğŸ“ Editar Investimento'; 
                document.getElementById('btnSubmitInvestimento').textContent = 'Atualizar Investimento';
                document.getElementById('btnCancelarEdicaoInvestimento').style.display = 'inline-block'; 
                document.getElementById('formInvestimento').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('dataInvestimento').focus(); // <<< FOCO AUTOMÃTICO AQUI
            }
        }
        function atualizarListaInvestimentos() {
            const tbody = document.getElementById('listaInvestimentos'); tbody.innerHTML = '';
            investimentos.forEach(i => {
                const rend = i.valorAtual - i.valorAplicado; 
                const percRend = i.valorAplicado !== 0 ? ((rend / i.valorAplicado) * 100).toFixed(2) : '0.00';
                const tr = document.createElement('tr'); tr.className = 'investimento-item';
                tr.innerHTML = `<td>${formatarData(i.data)}</td><td>${i.tipo}</td><td>${i.instituicao}</td><td>${formatarMoeda(i.valorAplicado)}</td><td>${formatarMoeda(i.valorAtual)}</td><td>${i.rentabilidade}% a.a.</td>
                    <td style="color:${rend >= 0 ? '#28a745':'#dc3545'}">${formatarMoeda(rend)} (${percRend}%)</td>
                    <td>
                        <button class="btn btn-info" onclick="popularFormularioInvestimentoParaEdicao(${i.id})">Editar</button>
                        <button class="btn btn-danger" onclick="removerInvestimento(${i.id})">Remover</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('contadorInvestimentos').textContent = investimentos.length; // <<< ATUALIZAR CONTADOR
        }
        function removerInvestimento(id) { /* ... (cÃ³digo anterior, jÃ¡ usa modal) ... */ 
            abrirModalConfirmacao("Remover este investimento?", () => {
                investimentos = investimentos.filter(i => i.id !== id);
                atualizarListaInvestimentos(); atualizarDashboard(); salvarDados();
                mostrarNotificacao('Investimento removido!', 'info');
            });
        }

        // --- RESERVA DE EMERGÃŠNCIA --- (sem alteraÃ§Ãµes na lÃ³gica principal)
        function configurarReserva(e) { /* ... (cÃ³digo anterior) ... */ 
            e.preventDefault();
            configuracaoReserva.valorAtual = parseFloat(document.getElementById('valorReservaAtual').value) || 0;
            configuracaoReserva.gastosEssenciais = parseFloat(document.getElementById('gastosEssenciais').value) || 0;
            atualizarAnaliseReserva(); atualizarDashboard(); salvarDados();
            mostrarNotificacao('Reserva atualizada!', 'success');
        }
        function atualizarAnaliseReserva() { /* ... (cÃ³digo anterior) ... */ 
            const meta = configuracaoReserva.gastosEssenciais * 6;
            const perc = configuracaoReserva.gastosEssenciais > 0 && meta > 0 ? Math.min(100, (configuracaoReserva.valorAtual / meta * 100)).toFixed(1) : 0;
            const meses = configuracaoReserva.gastosEssenciais > 0 ? (configuracaoReserva.valorAtual / configuracaoReserva.gastosEssenciais).toFixed(1) : 0;
            let statusHTML, recomendacao;
            if(configuracaoReserva.gastosEssenciais <= 0) { statusHTML = '<span>Configure gastos</span>'; recomendacao = 'Informe gastos essenciais.'; }
            else if (configuracaoReserva.valorAtual >= meta) { statusHTML = '<span class="status-adequada">âœ… Adequada</span>'; recomendacao = 'ParabÃ©ns! Reserva adequada.'; }
            else if (configuracaoReserva.valorAtual >= meta * 0.5) { statusHTML = '<span class="status-inadequada">âš ï¸ Em formaÃ§Ã£o</span>'; recomendacao = 'Continue poupando!'; }
            else { statusHTML = '<span class="status-inadequada">âŒ Inadequada</span>'; recomendacao = 'Priorize a reserva.'; }
            document.getElementById('statusReservaTexto').innerHTML = statusHTML;
            document.getElementById('mesesProtecao').textContent = `${meses} meses`;
            document.getElementById('recomendacao').textContent = recomendacao;
            document.getElementById('reservaAtualPage').textContent = formatarMoeda(configuracaoReserva.valorAtual);
            document.getElementById('metaReservaPage').textContent = formatarMoeda(meta);
            document.getElementById('percentualReserva').textContent = `${perc}%`;
            document.getElementById('faltaReserva').textContent = formatarMoeda(Math.max(0, meta - configuracaoReserva.valorAtual));
            document.getElementById('progressReservaPage').style.width = `${perc}%`;
        }

        // --- DASHBOARD --- (sem alteraÃ§Ãµes na lÃ³gica principal)
        function atualizarDashboard() { /* ... (cÃ³digo anterior) ... */ 
            const hoje = new Date(); const mesAtual = hoje.getMonth(); const anoAtual = hoje.getFullYear();
            const recMes = receitas.filter(r => { const d = new Date(r.data+'T00:00:00'); return d.getMonth()===mesAtual && d.getFullYear()===anoAtual; });
            const despMes = despesas.filter(d => { const dM = new Date(d.data+'T00:00:00'); return dM.getMonth()===mesAtual && dM.getFullYear()===anoAtual; });
            const totalRec = recMes.reduce((t,r)=>t+r.valor,0); const totalDesp = despMes.reduce((t,d)=>t+d.valor,0);
            const saldoM = totalRec - totalDesp; const totalInv = investimentos.reduce((t,i)=>t+i.valorAtual,0);
            document.getElementById('totalReceitas').textContent=formatarMoeda(totalRec);
            document.getElementById('totalDespesas').textContent=formatarMoeda(totalDesp);
            document.getElementById('saldoMes').textContent=formatarMoeda(saldoM);
            document.getElementById('saldoMes').style.color = saldoM >= 0 ? '#28a745':'#dc3545';
            document.getElementById('totalInvestimentos').textContent=formatarMoeda(totalInv);

            const metaRes = configuracaoReserva.gastosEssenciais * 6;
            const percResDash = configuracaoReserva.gastosEssenciais > 0 && metaRes > 0 ? Math.min(100, (configuracaoReserva.valorAtual / metaRes * 100)) : 0;
            document.getElementById('reservaAtual').textContent=formatarMoeda(configuracaoReserva.valorAtual);
            document.getElementById('metaReserva').textContent=formatarMoeda(metaRes);
            document.getElementById('progressReserva').style.width = `${percResDash}%`;
            const statusResDash = configuracaoReserva.gastosEssenciais <= 0 ? 'Configure' : configuracaoReserva.valorAtual >= metaRes ? '<span class="status-adequada">Adequada âœ…</span>' : '<span class="status-inadequada">Inadequada âš ï¸</span>';
            document.getElementById('statusReserva').innerHTML = statusResDash;

            atualizarTransacoesRecentes();
            atualizarListaReceitas(); 
            atualizarListaDespesas();
            atualizarListaInvestimentos();
        }
        function atualizarTransacoesRecentes() { /* ... (cÃ³digo anterior) ... */ 
             const tbody = document.querySelector('#tabelaTransacoes tbody'); tbody.innerHTML = '';
            const todas = [
                ...receitas.map(r=>({...r, tipoTransacao:'Receita', classe:'receita-item'})),
                ...despesas.map(d=>({...d, tipoTransacao:'Despesa', classe:'despesa-item'})),
                ...investimentos.map(i=>({...i, tipoTransacao:'Investimento', classe:'investimento-item', valor:i.valorAplicado, descricao:i.instituicao, categoria:i.tipo}))
            ];
            todas.sort((a,b)=>new Date(b.data)-new Date(a.data));
            todas.slice(0,10).forEach(t=>{
                const tr = document.createElement('tr'); tr.className = t.classe;
                const cat = t.categoria || '-';
                const valF = t.tipoTransacao === 'Receita' ? `+${formatarMoeda(t.valor)}` : `-${formatarMoeda(t.valor)}`;
                const corV = t.tipoTransacao === 'Receita'?'#28a745':t.tipoTransacao==='Investimento'?'#6f42c1':'#dc3545';
                tr.innerHTML = `<td>${formatarData(t.data)}</td><td>${t.tipoTransacao}</td><td>${t.descricao}</td><td>${cat}</td><td style="color:${corV};font-weight:bold;">${valF}</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- UTILITÃRIOS --- (sem alteraÃ§Ãµes na lÃ³gica principal)
        function calcularGastosEssenciais() { /* ... (cÃ³digo anterior) ... */ 
            const catsEss = ['Moradia','AlimentaÃ§Ã£o','Transporte','SaÃºde']; const mes = new Date().getMonth(); const ano = new Date().getFullYear();
            return despesas.filter(d=>{const dt=new Date(d.data+'T00:00:00'); return dt.getMonth()===mes && dt.getFullYear()===ano && catsEss.includes(d.categoria);}).reduce((t,d)=>t+d.valor,0);
        }
        setInterval(() => { /* ... (cÃ³digo anterior, sugestÃ£o de placeholder) ... */ 
            const inputGastos = document.getElementById('gastosEssenciais');
            if (inputGastos && (configuracaoReserva.gastosEssenciais === 0 || inputGastos.value === "0" || inputGastos.value === "")) {
                const gastosCalc = calcularGastosEssenciais();
                if (gastosCalc > 0) { inputGastos.placeholder = formatarMoeda(gastosCalc) + " (sugerido)"; }
            }
        }, 5000);

        // --- INICIALIZAÃ‡ÃƒO ---
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataReceita').value = hoje;
            document.getElementById('dataDespesa').value = hoje;
            document.getElementById('dataInvestimento').value = hoje;
            carregarDados(); // Isso agora tambÃ©m chamarÃ¡ popularTodosOsDropdownsDeCategoria e renderizarListasDeCategoriasGerenciador
        });
    </script>
</body>
</html>
